name: Deploy Checker Job

on:
  pull_request:
    types: [closed]
    branches: [main]
  release:
    types: [published]

jobs:
  deploy:
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    permissions:
      contents: read

    env:
      REGION: us-central1
      WORKSPACE: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
      PROJECT_ID: ${{ github.event_name == 'release' && 'is-it-down-prod' || 'is-it-down-dev' }}
      TERRAFORM_DIR: infra/terraform

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Enable build APIs
        run: |
          gcloud services enable \
            artifactregistry.googleapis.com \
            cloudbuild.googleapis.com \
            --project "$PROJECT_ID"

      - name: Ensure Artifact Registry repository exists
        run: |
          if ! gcloud artifacts repositories describe is-it-down \
            --project "$PROJECT_ID" \
            --location "$REGION" >/dev/null 2>&1; then
            gcloud artifacts repositories create is-it-down \
              --project "$PROJECT_ID" \
              --repository-format docker \
              --location "$REGION" \
              --description "is-it-down container images"
          fi

      - name: Build and push image
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/is-it-down/is-it-down-checker:${GITHUB_SHA}"
          gcloud builds submit --project "$PROJECT_ID" --tag "$IMAGE"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

      - name: Terraform init
        run: |
          terraform -chdir="$TERRAFORM_DIR" init -input=false \
            -backend-config="configs/config.${WORKSPACE}.tfbackend"

      - name: Terraform workspace select or create
        run: |
          terraform -chdir="$TERRAFORM_DIR" workspace select "$WORKSPACE" || \
          terraform -chdir="$TERRAFORM_DIR" workspace new "$WORKSPACE"

      - name: Terraform apply
        env:
          TF_VAR_image_tag: ${{ github.sha }}
        run: |
          terraform -chdir="$TERRAFORM_DIR" apply -input=false -auto-approve
